name: CI/CD Pipeline

on:
  # 1. Otomatis saat push ke master
  push:
    branches:
      - master
      - 'release/*'
      - '*-staging'

  # 2. Manual trigger
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch / tag (wajib: release/*, *-staging, atau master)'
        required: true
        default: master
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  validate:
    name: Validate Ref
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.ref.outputs.ref }}
      env: ${{ steps.env.outputs.env }}

    steps:
      - name: Resolve ref
        id: ref
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            REF="${GITHUB_REF#refs/heads/}"
          else
            REF="${{ github.event.inputs.ref }}"
          fi

          echo "Using ref: $REF"

          if [[ "$REF" != "master" && \
                "$REF" != release/* && \
                "$REF" != *-staging ]]; then
            echo "âŒ Branch tidak diizinkan: $REF"
            echo "Hanya master, release/*, atau *-staging"
            exit 1
          fi

          echo "ref=$REF" >> $GITHUB_OUTPUT

      - name: Resolve environment
        id: env
        run: |
          if [[ "$REF" == master ]]; then
            echo "env=production" >> $GITHUB_OUTPUT
          else
            echo "env=staging" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.ref }}

      - name: Build
        run: |
          echo "Build from ${{ needs.validate.outputs.ref }}"

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ needs.validate.outputs.env }}

    steps:
      - name: Deploy
        run: |
          echo "Deploying..."
          echo "Ref : ${{ needs.validate.outputs.ref }}"
          echo "Env : ${{ needs.validate.outputs.env }}"
