name: Release Branch → Auto Tag Staging

on:
  push:
    branches:
      - 'release/*'

permissions:
  contents: write   # wajib untuk create tag

jobs:
  auto-tag:
    name: Auto Create Staging Tag
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # penting untuk tag

      - name: Validate release branch
        id: version
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"

          echo "Branch: $BRANCH"

          if [[ ! "$BRANCH" =~ ^release/v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "❌ Branch harus format: release/vX.Y.Z"
            exit 1
          fi

          VERSION="${BASH_REMATCH[1]}"
          TAG="v${VERSION}-staging"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Check tag exists
        run: |
          if git rev-parse "${{ steps.version.outputs.tag }}" >/dev/null 2>&1; then
            echo "⚠️ Tag sudah ada, skip create"
            exit 0
          fi

      - name: Create staging tag
        run: |
          git tag -a "${{ steps.version.outputs.tag }}" \
            -m "Staging release v${{ steps.version.outputs.version }}"

          git push origin "${{ steps.version.outputs.tag }}"
