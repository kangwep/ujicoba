name: Deploy Production

on:
  workflow_dispatch:

jobs:
  deploy_production:
    runs-on: ubuntu-latest

    steps:
      - name: Ensure workflow triggered from staging tag
        run: |
          if [[ "$GITHUB_REF" != refs/tags/*-staging ]]; then
            echo "âŒ Production deploy must be triggered from a *-staging tag"
            exit 1
          fi

      - name: Checkout staging tag
        uses: actions/checkout@v4

      - name: Derive production tag
        id: tag
        run: |
          STAGING_TAG="${GITHUB_REF##*/}"
          PROD_TAG="${STAGING_TAG%-staging}"

          echo "prod_tag=$PROD_TAG" >> $GITHUB_OUTPUT

      - name: Create production tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git tag -a "${{ steps.tag.outputs.prod_tag }}" \
            -m "Production release ${{ steps.tag.outputs.prod_tag }}"

          git push origin "${{ steps.tag.outputs.prod_tag }}"

      - name: Build production image
        run: |
          docker build -t test-app:${{ steps.tag.outputs.prod_tag }} .

      - name: Deploy to PRODUCTION
        run: |
          echo "ðŸš€ Deploying ${{ steps.tag.outputs.prod_tag }} to PRODUCTION"

