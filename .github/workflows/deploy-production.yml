name: Deploy Production (Promote Only)

on:
  workflow_dispatch:

jobs:
  deploy_production:
    runs-on: ubuntu-latest

    steps:
      - name: Ensure triggered from staging tag
        run: |
          if [[ "$GITHUB_REF" != refs/tags/*-staging ]]; then
            echo "❌ Production must be triggered from *-staging tag"
            exit 1
          fi

      - name: Derive production tag
        id: tag
        run: |
          STAGING_TAG="${GITHUB_REF##*/}"
          PROD_TAG="${STAGING_TAG%-staging}"

          echo "staging_tag=$STAGING_TAG" >> $GITHUB_OUTPUT
          echo "prod_tag=$PROD_TAG" >> $GITHUB_OUTPUT

          echo "✅ STAGING TAG  = $STAGING_TAG"
          echo "✅ PROD TAG     = $PROD_TAG"

      - name: Simulate image promotion (NO BUILD)
        run: |
          echo "docker tag test-app:${{ steps.tag.outputs.staging_tag }} \
                       test-app:${{ steps.tag.outputs.prod_tag }}"
          echo "✅ IMAGE PROMOTED (NO REBUILD)"

      - name: Create clean production git tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git tag -a "${{ steps.tag.outputs.prod_tag }}" \
            -m "Production release ${{ steps.tag.outputs.prod_tag }}"

          git push origin "${{ steps.tag.outputs.prod_tag }}"
